<!doctype html>
<head>
<title>Twiiter</title>
<link href="/static/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="/static/css/jumbotron-narrow.css" rel="stylesheet">
<link href="/static/css/twiiter.css" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="container">
  <div class="header clearfix">
    <nav>
      <ul class="nav nav-pills pull-right">
        <li role="presentation"><a href="{{ url_for('handle_users') }}">View Users</a></li>
        {% if g.user %}
        <li role="presentation" class="dropdown">
          <a href="#" class="dropdown-toggle profile-button" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
            <!-- Dropdown <span class="caret"></span> -->
            <img class="img-circle" src="https://lh3.googleusercontent.com/-XdUIqdMkCWA/AAAAAAAAAAI/AAAAAAAAAAA/4252rscbv5M/photo.jpg" height="32" width="32">
          </a>
          <ul class="dropdown-menu dropdown-menu-right">
            <li><a href="#">View Profile</a></li>
            <li><a href="#">Settings</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="{{ url_for('logout') }}">Logout</a></li>
          </ul>
        </li>
        <li role="presentation" class="pill-button active">
          <a href="#" data-toggle="modal" data-target="#twiitModal">
            <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
          </a>
        </li>
        {% else %}
        <li role="presentation" class="active"><a href="{{ url_for('login') }}">Login</a></li>
        {% endif %}
      </ul>
    </nav>
    <a href="{{ url_for('index') }}">
      <h3 class="text-muted">Twiiter</h3>
    </a>
  </div>

  {% block body %}{% endblock %}


  <!-- Create Modal -->
  <div class="modal fade" id="twiitModal" tabindex="-1" role="dialog" aria-labelledby="twiitModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title text-center modal-dialog-header" id="twiitModalLabel">Compose Twiit</h4>
        </div>
        <div class="modal-body">
          <form id="twiitForm" action="/twiit" method="post" enctype="multipart/form-data">
          <textarea class="form-control twiit-input" name="text" rows="5"></textarea>
          <img class="img-preview center-block" style="display: none;" alt="preview">
        </div>
        <div class="modal-footer">
          <label class="btn btn-default btn-info btn-file pull-left">
            Upload Photo <span class="glyphicon glyphicon-picture" aria-hidden="true"></span>
            <input type="file" name="image-file" accept="image/jpeg">
          </label>

          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Twiit</button>
          </form>
        </div>
      </div>
    </div>
  </div>


  <footer class="footer">
    <p>&copy; 2017 Twiiter, Inc.</p>
  </footer>

  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <script src="/static/js/bootstrap.min.js"></script>
  <script src="/static/js/moment.js"></script>
  <script type=text/javascript>
    function readURL(input) {
      if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {
          $('img.img-preview').attr('src', e.target.result);
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    function updateTimeagos() {
      //  Convert timestamps to timeagos
      $("span.twiit-timestamp").each(function(i, e) {
        //  Convert to UTC to local then get time from now
        var timestamp=  $(this).data("timestamp");
        $(this).text(moment.utc(timestamp).local().fromNow());
      });

      //  Refreshes every 30s
      window.setInterval(function(){
        updateTimeagos();
      }, 30000);
    }

    $(function() {
      updateTimeagos();

      {% if session['google_token'] %}
      //  Focus on modal shown
      $('.modal').on("shown.bs.modal", function(e) {
        $("textarea[name='text']").focus();
      });

      //  Clear on modal hidden
      $('.modal').on('hidden.bs.modal', function(e) {
        $("img.img-preview").attr("src", "").hide();
        $("textarea[name='text']").val("");
      });

      $('input:file').change(function() {
        readURL(this);
        $("img.img-preview").show();
        var label = $(this).val().replace(/\\/g, '/').replace(/.*\//, '');
        console.log(label);
      });
      //   $('img.img-preview').attr('data-uploaded', false);
      //   var form_data = new FormData($('#twiitForm')[0]);
      //   $.ajax({
      //       type: 'POST',
      //       url: '/upload',
      //       data: form_data,
      //       contentType: false,
      //       cache: false,
      //       processData: false,
      //       async: false,
      //       success: function(data) {
      //           console.log('Success!');
      //           $('img.img-preview').attr('data-uploaded', true);
      //           $('img.img-preview').attr('data-url', '<<url goes here>>');
      //           $(this).val("");  // Workaround to detect change when filename is the same
      //       },
      //   });
      // });
      //
      // $("#twiitForm").submit(function(e) {
      //   e.preventDefault();
      //   // var payload = $(this).serialize() + "&access_token={{session['google_token'][0]}}";
      //   if ($("textarea[name='text']").val().length > 0 || $('img.img-preview').is('[data-uploaded]')) {
      //
      //     // if photo has been uploaded
      //
      //     var payload = $(this).serialize();
      //     console.log(payload);
      //     // $.post("/twiit", payload)
      //     //   .done(function(data) {
      //     //     $("textarea[name='text']").val("");
      //     //     $("#twiitModal").modal('hide');
      //     //     console.log(data);
      //     //     window.location.href = "{{ url_for('index') }}";
      //     // });
      //   }
      // });
      {% endif %}
    });

  // Script for index
  $(function() {
    // use click to get the twiit_id context to populate the modal
    $("a.delete-twiit-button").click(function(e) {
      e.preventDefault(); // allows for fallback to manual linking if change to GET interface
      var twiit_id = $(this).data('id');
      $.get("twiit/"+twiit_id)
        .done(function(data) {
          $("#delete-twiit-content").html(data.text);
          var timestamp = data.hasOwnProperty("updated_at") ? data.updated_at : data.created_at;
          $("#delete-twiit-timestamp").attr("data-timestamp", timestamp);
          $("#delete-twiit-timestamp").text(moment.utc(timestamp).local().fromNow());
          if (data.hasOwnProperty("image_url")) {
            $("#delete-twiit-img").attr("src", data.image_url).show();
          }
          $("#confirm-delete-button").data("twiit-id", twiit_id);
          $('#deleteTwiitModal').modal("show");
        });
    });

    $("a.edit-twiit-button").click(function(e) {
      e.preventDefault(); // allows for fallback to manual linking if change to GET interface
      var twiit_id = $(this).data('id');
      $.get("twiit/"+twiit_id)
        .done(function(data) {
          $("#edit-twiit-content").val(data.text);
          var timestamp = data.hasOwnProperty("updated_at") ? data.updated_at : data.created_at;
          $("#edit-twiit-timestamp").attr("data-timestamp", timestamp);
          $("#edit-twiit-timestamp").text(moment.utc(timestamp).local().fromNow());
          if (data.hasOwnProperty("image_url")) {
            $("#edit-twiit-img").attr("src", data.image_url).show();
          }
          $("#confirm-edit-button").data("twiit-id", twiit_id);
          $('#editTwiitModal').modal("show");
        });
    });

    $("#confirm-delete-button").click(function(e) {
      var twiit_id = $(this).data("twiit-id");
      console.log(twiit_id);
      $.ajax({
        url: "twiit/"+twiit_id,
        type: 'DELETE',
        success: function(data) {
          location.reload();
        },
      });
    });

    $("#confirm-edit-button").click(function(e) {
      var twiit_id = $(this).data("twiit-id");
      $.ajax({
        url: "twiit/"+twiit_id,
        type: 'PUT',
        data: $("form#edit-twiit-form").serialize(),
        success: function(data) {
          location.reload();
        },
      });
    });
  });

  </script>
</div> <!-- /container -->
</body>
</html>
