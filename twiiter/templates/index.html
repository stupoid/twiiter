{% extends "layout.html" %}
{% block body %}

{% if twiits|length == 0 %}
  {% if tag %}
    <h3>Nobody used this tag yet</h3>
  {% elif g.user %}
    <h3>Nobody you followed has twiited yet</h3>
  {% else %}
    <h3>Nobody has twiited yet</h3>
  {% endif %}
{% endif %}

{% for twiit in twiits %}
<div class="panel panel-default">
  <div class="panel-body">
    {% if twiit.user_id == g.user.id %}
    <div class="dropdown pull-right">
      <button class="btn btn-default btn-twiit-menu dropdown-toggle" type="button" id="twiitDropdownMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
        <span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span>
      </button>
      <ul class="dropdown-menu" aria-labelledby="twiitDropdownMenu">
        <li><a href="#" class="edit-twiit-button" data-id="{{ twiit.id }}">Edit Twiit</a></li>
        <li><a href="#" class="delete-twiit-button" data-id="{{ twiit.id }}">Delete Twiit</a></li>
      </ul>
    </div>
    {% endif %}
    <div class="media">
      <div class="media-left">
        <img class="media-object" src="{{ twiit.user.picture }}" height="64" width="64">
      </div>
      <div class="media-body">
        <h4 class="media-heading">{{ twiit.user.name }}</h4>
        <p class="twiit-handle">{{ twiit.user.email }} &bull;
          {% if twiit.updated_at %} edited {% endif %}
          <span class="twiit-timestamp" data-timestamp="{{ twiit.updated_at or twiit.created_at }}"></span>
        </p>
        <div class="twiit-content">{{ twiit.text|linebreaks }}</div>
        {% if twiit.image_url %}
        <img src="{{ twiit.image_url }}">
        {% endif %}

        {% if twiit.tags %}
          <div>tags: 
          {% for tag in twiit.tags.split(', ') %}
            <a href="/tag/{{ tag }}">#{{ tag }}</a>
          {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% if g.user %}
<!-- Delete Modal -->
<div class="modal fade" id="deleteTwiitModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title text-center modal-dialog-header">Are you sure you want to delete this Twiit?</h4>
      </div>
      <div class="modal-body">
        <div class="media">
          <div class="media-left">
            <img class="media-object" src="{{ g.user.picture}}" height="64" width="64">
          </div>
          <div class="media-body">
            <h4 class="media-heading">{{ g.user.name }}</h4>
            <p class="twiit-handle">{{ g.user.email }} &bull; <span id="delete-twiit-timestamp" class="twiit-timestamp"></span></p>
            <div id="delete-twiit-content" class="twiit-content">Placeholder Content</div>
            <img id="delete-twiit-img" style="display: none;" src="">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" id="confirm-delete-button" class="btn btn-primary">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editTwiitModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title text-center modal-dialog-header">Edit Twiit</h4>
      </div>
      <div class="modal-body">
        <div class="media">
          <div class="media-left">
            <img class="media-object" src="{{ g.user.picture}}" height="64" width="64">
          </div>
          <div class="media-body">
            <h4 class="media-heading">{{ g.user.name }}</h4>
            <p class="twiit-handle">{{ g.user.email }} &bull; <span id="edit-twiit-timestamp" class="twiit-timestamp"></span></p>
            <form id="edit-twiit-form">
            <textarea style="display: none;" class="form-control twiit-input create-twiit-textarea" name="text" rows="5"></textarea>
            <div class="twiit-textarea" contenteditable></div>
            </form>
            <img id="edit-twiit-img" class="img-preview center-block" style="display: none;">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" id="confirm-edit-button" class="btn btn-primary">Confirm Edit</button>
      </div>
    </div>
  </div>
</div>

<script type=text/javascript>
$(function() {
  // use click to get the twiit_id context to populate the modal
  $("a.delete-twiit-button").click(function(e) {
    e.preventDefault(); // allows for fallback to manual linking if change to GET interface
    var twiit_id = $(this).data('id');
    $.get("/twiit/"+twiit_id)
      .done(function(data) {
        $("#delete-twiit-content").html(data.text);
        var timestamp = data.hasOwnProperty("updated_at") ? data.updated_at : data.created_at;
        $("#delete-twiit-timestamp").attr("data-timestamp", timestamp);
        $("#delete-twiit-timestamp").text(moment.utc(timestamp).local().fromNow());
        if (data.hasOwnProperty("image_url")) {
          $("#delete-twiit-img").attr("src", data.image_url).show();
        }
        $("#confirm-delete-button").data("twiit-id", twiit_id);
        $('#deleteTwiitModal').modal("show");
      });
  });

  $("a.edit-twiit-button").click(function(e) {
    e.preventDefault(); // allows for fallback to manual linking if change to GET interface
    var twiit_id = $(this).data('id');
    $.get("/twiit/"+twiit_id)
      .done(function(data) {
        var text = data.text.replace(/'\r\n'/g, "<br>").replace(/#\w+/gi, function(t) {
          var tag = t.replace("#", "")
          return t.link("/tag/"+tag);
        });
        $("div.twiit-textarea").html(text);
        $("textarea.create-twiit-textarea").val(data.text);

        var timestamp = data.hasOwnProperty("updated_at") ? data.updated_at : data.created_at;
        $("#edit-twiit-timestamp").attr("data-timestamp", timestamp);
        $("#edit-twiit-timestamp").text(moment.utc(timestamp).local().fromNow());
        if (data.hasOwnProperty("image_url")) {
          $("#edit-twiit-img").attr("src", data.image_url).show();
        }
        $("#confirm-edit-button").data("twiit-id", twiit_id);
        $('#editTwiitModal').modal("show");
      });
  });

  $("#confirm-delete-button").click(function(e) {
    var twiit_id = $(this).data("twiit-id");
    $.ajax({
      url: "/twiit/"+twiit_id,
      type: 'DELETE',
      success: function(data) {
        location.reload();
      },
    });
  });

  $("#confirm-edit-button").click(function(e) {
    var twiit_id = $(this).data("twiit-id");
    $.ajax({
      url: "/twiit/"+twiit_id,
      type: 'PUT',
      data: $("form#edit-twiit-form").serialize(),
      success: function(data) {
        location.reload();
      },
    });
  });
});
</script>
{% endif %}
{% endblock %}
